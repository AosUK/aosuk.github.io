const modesJSON = `
{
  "1": "Beginner",
  "2": "Intermediate",
  "3": "Expert"
}
`;

const modeColorMap = {
  1: 'green',
  2: 'blue',
  3: 'red',
  0: 'cream'
};//maybe move this into modejson

const playersJSON = `
{
  "fields": ["id", "name"],
  "data": [
    [1, "Player"],
    [19938283, "A-O-S"],
    [2150671, "Luna"],
    [8146485, "Cachow"],
    [733893, "Llama"],
    [10824130, "055D"],
    [3020427, "Rory"],
    [7395472, "Jeff"],
    [7534731, "Svedas"],
    [24343172, "bot1k"],
    [6229919, "Anonymous6229919"],
    [1537421, "trckui11"],
    [5587951, "Mario Pro Gamer"],
    [4969972, "cat"],
    [8974083, "Md-101"],
    [1457912, "Thrainos"],
    [4946833, "rustixx"],
    [15734516, "vvvf"],
    [7334132, "Oreh1337"],
    [3697173, "oreotheuser"],
    [5803475, "ditszies"],
    [4314727, "brandib714"]
  ]
}
`;


const gamesJSON = `
{
  "fields": ["id", "mode", "playerid", "3bv", "clicks"],
  "data": [
    [1, 0, 1, 1, 100],
    [4546455340, 1, 19938283, 17, 8],
    [4591584617, 1, 19938283, 17, 8],
    [4722771143, 1, 19938283, 34, 16],
    [4713331086, 1, 19938283, 9, 4],
    [4383375566, 2, 19938283, 87, 55],
    [4626713003, 2, 19938283, 78, 50],
    [3818921625, 3, 19938283, 163, 141],
    [1578361577, 1, 8146485, 17, 7],
    [3137261850, 1, 8146485, 21, 9],
    [2698767704, 1, 8146485, 20, 9],
    [3077289780, 1, 8146485, 24, 11],
    [4093004920, 1, 8146485, 26, 12],
    [2574347450, 1, 8146485, 15, 7],
    [2524984870, 1, 8146485, 15, 7],
    [3149487353, 1, 8146485, 32, 15],
    [3134109637, 1, 8146485, 32, 15],
    [3025618045, 1, 8146485, 17, 8],
    [2208507453, 1, 8146485, 17, 8],
    [2302860293, 1, 8146485, 19, 9],
    [2703706523, 1, 8146485, 21, 10],
    [2693148822, 1, 8146485, 21, 10],
    [2003458106, 1, 8146485, 21, 10],
    [1575762263, 1, 8146485, 21, 10],
    [3118940303, 1, 8146485, 31, 15],
    [3553799116, 1, 8146485, 29, 14],
    [3099325364, 1, 8146485, 39, 19],
    [546033402,  1, 3020427,  21, 9],
    [1474303332, 1, 3020427,  25, 11],
    [2666394949, 1, 7395472,  16, 7],
    [1699800359, 1, 7395472,  28, 13],
    [2142587595, 1, 7395472, 15, 7],
    [2572434973, 1, 7395472, 21, 10],
    [2587267357, 1, 7395472, 23, 11],
    [2237144123, 1, 7395472, 25, 12],
    [1709006084, 1, 7395472, 27, 13],
    [1691512329, 1, 7395472, 27, 13],
    [1612417297, 1, 7395472, 25, 12],
    [1687621210, 1, 7534731, 18, 8],
    [3933619018, 1, 7534731, 29, 14],
    [3949372516, 1, 24343172, 16, 7],
    [1060564856,  1, 6229919, 14, 6],
    [465282533, 1, 1537421, 18, 8],
    [2449439787, 1, 5587951, 18, 8],
    [1028818941, 1, 3697173, 26, 12],
    [1297349578, 1, 3697173, 27, 12],
    [4054529463, 1, 4969972,  23, 11],
    [3993937684,  1, 4969972, 29, 14],
    [4332759135, 1, 4969972,  22, 11],
    [4318648061,  1, 4969972, 34, 17],
    [3693718875, 1, 4969972,  18, 9],
    [3542886830, 1, 4969972,  20, 10],
    [3503600386, 1, 4969972,  28, 14],
    [3478213980, 1, 4969972,  22, 11],
    [3441834094, 1, 4969972,  18, 9],
    [3402867895, 1, 4969972,  16, 8],
    [3232732403, 1, 4969972,  20, 10],
    [2284985087, 1, 4969972,  16, 8],
    [2204906266, 1, 4969972,  16, 8],
    [3702285538, 2, 4969972,  78, 46],
    [3805679095, 2, 4969972,  74, 44],
    [3067379681, 2, 4969972,  99, 59],
    [4684176441, 2, 4969972,  96, 58],
    [3705320420, 2, 4969972,  82, 50],
    [4681914512, 2, 4969972,  72, 44],
    [2537462494, 2, 4969972,  99, 61],
    [4237571976, 2, 4969972,  100,62],
    [4559361752, 2, 4969972,  77, 48],
    [4689054546, 2, 4969972,  85, 53],
    [3237080953, 3, 4969972,  187, 130],
    [3254704331, 3, 4969972,  203, 142],
    [3575162566, 3, 4969972,  222, 156],
    [3607350786, 3, 4969972,  231, 163],
    [3818946794, 3, 4969972,  226, 160],
    [2796523849, 3, 4969972,  223, 159],
    [4092020485, 3, 4969972,  203, 145],
    [475031334 , 3, 4969972,  208, 149],
    [2991491884, 1, 8974083,  33, 15],
    [3227492077, 1, 8974083,  26, 12],
    [1571910922, 1, 8974083,  17, 8],
    [2771142908, 1, 8974083,  27, 13],
    [2473948465, 1, 8974083,  25, 12],
    [1587611740, 1, 8974083,  27, 13],
    [2429419706, 1, 8974083,  31, 15],
    [2148203847, 1, 8974083,  37, 18],
    [4723964979, 1, 1457912,  44, 20],
    [4659573205, 1, 1457912,  28, 13],
    [4591947185, 1, 1457912,  34, 16],
    [4549164406, 1, 1457912,  19, 9],
    [3536090223, 1, 1457912,  21, 10],
    [4497068721, 1, 1457912,  21, 10],
    [3777277292, 1, 1457912,  27, 13],
    [4489544432, 3, 1457912,  211, 137],
    [4415263702, 2, 1457912,  106, 56],
    [3723205594, 2, 1457912,  95, 51],
    [2517077785, 1, 4946833, 35 , 16],
    [4312368339, 1, 4946833, 37 , 17],
    [3327595990, 1, 4946833, 34 , 16],
    [3859336557, 1, 4946833, 19 , 9],
    [4495820047, 1, 4946833, 40 , 19],
    [4062060541, 1, 4946833, 25 , 12],
    [4401268823, 1, 4946833, 25 , 12],
    [1103849536, 1, 4946833, 16 , 8],
    [1441470423, 1, 4946833, 16 , 8],
    [2956856522, 1, 4946833, 18 , 9],
    [3414526041, 1, 4946833, 18 , 9],
    [4004964447, 1, 4946833, 34 , 17],
    [4081239630, 1, 4946833, 16 , 8],
    [4173640688, 1, 4946833, 18 , 9],
    [4213775524, 1, 4946833, 16 , 8],
    [4312368339, 1, 4946833, 20 , 10],
    [4470366309, 1, 4946833, 32 , 16],
    [4562684580, 1, 4946833, 14 , 7],
    [4593911998, 1, 4946833, 32 , 16],
    [4405065385, 1, 15734516, 22 , 10],
    [3123330086, 1, 7334132, 22, 10],
    [3793961803, 1, 7334132, 17 , 8],
    [3795405180, 1, 7334132, 21 , 10],
    [3070258353, 1, 7334132, 23, 11],
    [3772004595, 1, 7334132, 25 , 12],
    [3132221898, 1, 7334132, 35 ,17],
    [4054876113, 1, 7334132, 35 , 17],
    [3769195287, 1, 10824130, 16 ,7 ],
    [4435972750, 1, 10824130, 22 ,10],
    [4328974503, 1, 10824130, 28 ,13],
    [4648930103, 1, 10824130, 32 ,15],
    [4612751646, 1, 10824130, 19 ,9 ],
    [4048715462, 1, 10824130, 21 ,10],
    [4118962861, 1, 10824130, 21 ,10],
    [4334405785, 1, 10824130, 23 ,11],
    [3778420878, 1, 10824130, 25 ,12],
    [4158571742, 1, 10824130, 25 ,12],
    [3702973325, 1, 10824130, 27 ,13],
    [3811008970, 1, 10824130, 29 ,14],
    [3909399046, 1, 10824130, 31 ,15],
    [3951373022, 1, 10824130, 24 ,12],
    [4175339347, 1, 10824130, 26 ,13],
    [4178920409, 1, 10824130, 28 ,14],
    [3614882621, 1, 10824130, 22 ,11],
    [4462591109, 1, 10824130, 14 ,7 ],
    [2900195838, 1, 10824130, 16 ,8 ],
    [3616415041, 1, 10824130, 18 ,9 ],
    [4134289975, 1, 10824130, 18 ,9 ],
    [3838615534, 1, 10824130, 20 ,10],
    [4050959396, 1, 10824130, 20 ,10],
    [4723736497, 1, 10824130, 20 ,10],
    [4157816149, 1, 10824130, 22 ,11],
    [3857014861, 1, 10824130, 24 ,12],
    [4182858409, 1, 10824130, 24 ,12],
    [3357480622, 1, 10824130, 28 ,14],
    [3512773734, 1, 10824130, 28 ,14],
    [3775148147, 1, 10824130, 30 ,15],
    [4005413740, 1, 10824130, 30 ,15],
    [4126576540, 1, 10824130, 30 ,15],
    [4137558941, 1, 10824130, 32 ,16],
    [4640728210, 1, 10824130, 32 ,16],
    [3779615475, 1, 10824130, 38 ,19],
    [4713430001, 1, 10824130, 18 ,9 ],
    [4116811644, 1, 733893, 31, 12],
    [3306358669, 1, 733893, 27, 12],
    [4623358397, 1, 733893, 29, 13],
    [4081965155, 1, 733893, 29, 13],
    [4766389484, 1, 733893, 22, 10],
    [4742698760, 1, 733893, 13, 6],
    [4721151080, 1, 733893, 13, 6],
    [3281013514, 1, 733893, 13, 6],
    [4714607778, 1, 733893, 28, 13],
    [4046203684, 1, 733893, 28, 13],
    [1689049605, 1, 733893, 28, 13],
    [4765978618, 1, 733893, 32, 15],
    [4724860008, 1, 733893, 17, 8],
    [4217025886, 1, 733893, 17, 8],
    [2674528526, 1, 733893, 17, 8],
    [4721177915, 1, 733893, 19, 9],
    [3151332197, 1, 733893, 19, 9],
    [4761378395, 1, 733893, 23, 11],
    [4763900677, 1, 733893, 25, 12],
    [4228430745, 1, 733893, 25, 12],
    [4814175699, 1, 733893, 27, 13],
    [4063760401, 1, 733893, 27, 13],
    [4063640964, 1, 733893, 27, 13],
    [4766991470, 1, 733893, 29, 14],
    [4757056945, 1, 733893, 31, 15],
    [4429772846, 1, 733893, 31, 15],
    [3296108930, 1, 733893, 31, 15],
    [4167458152, 1, 733893, 33, 16],
    [3142351035, 1, 733893, 39, 19],
    [4842277824, 1, 733893, 14, 7],
    [4834099613, 1, 733893, 30, 15],
    [4829955443, 1, 733893, 18, 9],
    [4822671908, 1, 733893, 28, 14],
    [4814261173, 1, 733893, 22, 11],
    [4801687571, 1, 733893, 14, 7],
    [4773473208, 1, 733893, 32, 16],
    [4770792170, 1, 733893, 14, 7],
    [4770249756, 1, 733893, 20, 10],
    [4768764073, 1, 733893, 14, 7],
    [4767448017, 1, 733893, 20, 10],
    [4767412019, 1, 733893, 20, 10],
    [4764104611, 1, 733893, 22, 11],
    [4763299319, 1, 733893, 14, 7],
    [4761243388, 1, 733893, 26, 13],
    [4753935371, 1, 733893, 12, 6],
    [4753729143, 1, 733893, 18, 9],
    [4753686052, 1, 733893, 26, 13],
    [4749585859, 1, 733893, 30, 15],
    [4746102499, 1, 733893, 28, 14],
    [4745414426, 1, 733893, 18, 9],
    [4742583026, 1, 733893, 22, 11],
    [4732072051, 1, 733893, 26, 13],
    [4724461465, 1, 733893, 28, 14],
    [4720837080, 1, 733893, 34, 17],
    [4720271382, 1, 733893, 32, 16],
    [4720194946, 1, 733893, 16, 8],
    [4717946486, 1, 733893, 16, 8],
    [4619888895, 1, 733893, 22, 11],
    [4619886863, 1, 733893, 20, 10],
    [4619857990, 1, 733893, 24, 12],
    [4545862564, 1, 733893, 28, 14],
    [4545806576, 1, 733893, 28, 14],
    [4545764642, 1, 733893, 24, 12],
    [4437280958, 1, 733893, 22, 11],
    [4363957121, 1, 733893, 26, 13],
    [4336402330, 1, 733893, 38, 19],
    [4135569697, 1, 733893, 16, 8],
    [4069974626, 1, 733893, 24, 12],
    [4067254524, 1, 733893, 18, 9],
    [4064279157, 1, 733893, 22, 11],
    [4063962886, 1, 733893, 20, 10],
    [4061185279, 1, 733893, 24, 12],
    [4061099857, 1, 733893, 22, 11],
    [4060691638, 1, 733893, 26, 13],
    [4057263005, 1, 733893, 20, 10],
    [4053946638, 1, 733893, 20, 10],
    [4045957526, 1, 733893, 26, 13],
    [4004038926, 1, 733893, 22, 11],
    [3961206841, 1, 733893, 26, 13],
    [3882463824, 1, 733893, 24, 12],
    [3867314656, 1, 733893, 10, 5],
    [3835875531, 1, 733893, 26, 13],
    [3441512665, 1, 733893, 32, 16],
    [3309386810, 1, 733893, 10, 5],
    [3301808975, 1, 733893, 20, 10],
    [3293649653, 1, 733893, 24, 12],
    [3282968737, 1, 733893, 24, 12],
    [3263062542, 1, 733893, 24, 12],
    [3151251088, 1, 733893, 24, 12],
    [3127099623, 1, 733893, 22, 11],
    [3078308747, 1, 733893, 16, 8],
    [2822830230, 1, 733893, 22, 11],
    [2807368166, 1, 733893, 26, 13],
    [2789980903, 1, 733893, 24, 12],
    [2698749959, 1, 733893, 32, 16],
    [2568163515, 1, 733893, 28, 14],
    [1517532990, 1, 733893, 24, 12],
    [1483942752, 1, 733893, 20, 10],
    [1404587020, 1, 733893, 22, 11],
    [1223574070, 1, 733893, 28, 14],
    [808240763, 1,  733893, 24, 12],
    [5074691399, 1, 5803475, 15, 6],
    [5084733339, 1, 4314727, 19, 10],
    [5055902215, 2, 4314727, 74, 53],
    [65229945451, 1, 2150671,  21,  9],
    [565781171, 1, 2150671,  25,  11],
    [1334361570, 1, 2150671,  34,  15],
    [4031543916, 1, 2150671,  27,  12],
    [4115514372, 1, 2150671,  20,  9],
    [5244604146, 1, 2150671,  20,  9],
    [3975543590, 1, 2150671,  20,  9],
    [611879354, 1, 2150671,  22,  10],
    [4751937524, 1, 2150671,  24,  11],
    [4832447193, 1, 2150671,  26,  12],
    [4589672446, 1, 2150671,  26,  12],
    [1207345667, 1, 2150671,  13,  6],
    [4829878036, 1, 2150671,  13,  6],
    [4708301984, 1, 2150671,  28,  13],
    [1337568060, 1, 2150671,  28,  13],
    [5108716737, 1, 2150671,  28,  13],
    [1230793519, 1, 2150671,  28,  13],
    [2461044370, 1, 2150671,  15,  7],
    [5056248910, 1, 2150671,  15,  7],
    [4845797657, 1, 2150671,  15,  7],
    [3712329000, 1, 2150671,  15,  7],
    [5225141839, 1, 2150671,  17,  8],
    [4759917858, 1, 2150671,  38,  18],
    [4898198213, 1, 2150671,  19,  9],
    [4658153516, 1, 2150671,  21,  10],
    [4758116385, 1, 2150671,  21,  10],
    [2990090072, 1, 2150671,  21,  10],
    [4817867116, 1, 2150671,  23,  11],
    [4916332068, 1, 2150671,  25,  12],
    [5012054274, 1, 2150671,  25,  12],
    [4946663425, 1, 2150671,  25,  12],
    [859329450, 1, 2150671,  25,  12],
    [1045693371, 1, 2150671,  25,  12],
    [3534879245, 1, 2150671,  25,  12],
    [1212638027, 1, 2150671,  27,  13],
    [4905067261, 1, 2150671,  29,  14],
    [4923279565, 1, 2150671,  29,  14],
    [4702354273, 1, 2150671,  31,  15],
    [4674674072, 1, 2150671,  31,  15],
    [4879965481, 1, 2150671,  31,  15],
    [4677082950, 1, 2150671,  31,  15],
    [4781137204, 1, 2150671,  31,  15],
    [4934462380, 1, 2150671,  33,  16],
    [5196681094, 1, 2150671,  35,  17],
    [5149288887, 1, 2150671,  35,  17],
    [4870777985, 1, 2150671,  39,  19],
    [4770108601, 1, 2150671,  41,  20],
    [4688359230, 1, 2150671,  43,  21],
    [5141831587, 1, 2150671,  10,  5],
    [5142676129, 1, 2150671,  10,  5],
    [4093089154, 1, 2150671,  14,  7],
    [4900942167, 1, 2150671,  14,  7],
    [796457106, 1, 2150671,  8,  4],
    [5184582312, 1, 2150671,  16,  8],
    [3500284515, 1, 2150671,  12,  6],
    [5176738593, 1, 2150671,  14,  7],
    [5000144437, 1, 2150671,  20,  10],
    [4899791656, 1, 2150671,  18,  9],
    [4868283999, 1, 2150671,  18,  9],
    [4822258352, 1, 2150671,  18,  9],
    [4741076386, 1, 2150671,  20,  10],
    [764967622, 1, 2150671,  16,  8],
    [4182924548, 1, 2150671,  16,  8],
    [4911504572, 1, 2150671,  22,  11],
    [5208524253, 1, 2150671,  26,  13],
    [5247049995, 1, 2150671,  26,  13],
    [4893205370, 1, 2150671,  22,  11],
    [4775409841, 1, 2150671,  20,  10],
    [598978484, 1, 2150671,  18,  9],
    [4782799664, 1, 2150671,  24,  12],
    [1294211307, 1, 2150671,  14,  7],
    [4938834968, 1, 2150671,  14,  7],
    [4850537751, 1, 2150671,  16,  8],
    [4679017070, 1, 2150671,  16,  8],
    [1562885350, 1, 2150671,  10,  5],
    [4732136066, 1, 2150671,  22,  11],
    [4835611971, 1, 2150671,  22,  11],
    [4882947156, 1, 2150671,  18,  9],
    [4783939918, 1, 2150671,  24,  12],
    [4937773707, 1, 2150671,  24,  12],
    [4837323521, 1, 2150671,  30,  15],
    [4899676398, 1, 2150671,  30,  15],
    [4743835026, 1, 2150671,  26,  13],
    [4937117310, 1, 2150671,  24,  12],
    [4517686452, 1, 2150671,  32,  16],
    [5012654969, 1, 2150671,  24,  12],
    [3324493338, 1, 2150671,  28,  14],
    [5193180933, 1, 2150671,  22,  11],
    [3263024778, 1, 2150671,  28,  14],
    [4833778877, 1, 2150671,  32,  16],
    [5193404203, 1, 2150671,  28,  14],
    [5003181350, 1, 2150671,  14,  7],
    [4685913265, 1, 2150671,  16,  8],
    [4923510768, 1, 2150671,  20,  10],
    [5221047429, 1, 2150671,  18,  9],
    [4944494275, 1, 2150671,  30,  15],
    [4790805442, 1, 2150671,  24,  12],
    [1309104423, 1, 2150671,  12,  6],
    [4516611555, 1, 2150671,  32,  16],
    [4854611036, 1, 2150671,  38,  19],
    [4818173841, 1, 2150671,  32,  16],
    [4775319805, 1, 2150671,  20,  10],
    [812927326, 1, 2150671,  26,  13],
    [4763794138, 1, 2150671,  28,  14],
    [1267100993, 1, 2150671,  28,  14],
    [5223048219, 1, 2150671,  22,  11],
    [809128141, 1, 2150671,  30,  15],
    [1430516217, 1, 2150671,  38,  19],
    [4714282131, 1, 2150671,  26,  13],
    [4467288414, 1, 2150671,  38,  19],
    [1267106202, 1, 2150671,  28,  14],
    [1179751077, 1, 2150671,  32,  16],
    [4628712183, 1, 2150671,  44,  22],
    [4875633531, 1, 2150671,  20,  10],
    [1252928494, 1, 2150671,  26,  13],
    [3292858823, 1, 2150671,  28,  14],
    [790724369, 1, 2150671,  20,  10],
    [4828211057, 1, 2150671,  38,  19],
    [852262679, 1, 2150671,  26,  13],
    [1246675324, 1, 2150671,  20,  10],
    [1459886139, 1, 2150671,  20,  10],
    [1324037108, 1, 2150671,  10,  5],
    [4706541316, 3, 4314727, 214, 177]
  ]
}
`;


const parsedPlayers = JSON.parse(playersJSON);

const players = parsedPlayers.data.map(row => {
  const obj = {};
  parsedPlayers.fields.forEach((field, i) => {
    obj[field] = row[i];
  });
  return obj;
});
const parsedGames = JSON.parse(gamesJSON);

const games = parsedGames.data.map(row => {
  const obj = {};
  parsedGames.fields.forEach((field, i) => {
    obj[field] = row[i];
  });
  return obj;
});

const modes = JSON.parse(modesJSON);

const playerMap = {};
players.forEach(player => {
  playerMap[player.id] = player.name;
});

function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    playerid: Number(params.get('playerid')) || 0,
    mode: Number(params.get('mode')) || 0
  };
}

function updateURLWithPlayerId(playerid) {
  const params = new URLSearchParams(window.location.search);
  if (playerid === null || playerid === 0) {
    params.delete('playerid');
  } else {
    params.set('playerid', playerid);
  }
  const newUrl = `${window.location.pathname}?${params.toString()}`;
  history.pushState(null, '', newUrl);
  renderTable();
}

function updateURLWithMode(mode) {
  const params = new URLSearchParams(window.location.search);
  if (mode === null || mode === 0) {
    params.delete('mode');
  } else {
    params.set('mode', mode);
  }
  const newUrl = `${window.location.pathname}?${params.toString()}`;
  history.pushState(null, '', newUrl);
  renderTable();
}

function renderTable() {
  const { playerid, mode } = getQueryParams();
  const tableBody = document.getElementById('game-list');
  const filterInfo = document.getElementById('filter-info');
  tableBody.innerHTML = '';

  const filteredGames = games.filter(game => {
    const matchPlayer = playerid === 0 || game.playerid === playerid;
    const matchMode = mode === 0 || game.mode === mode;
    return matchPlayer && matchMode;
  });

  const uniqueGamesMap = new Map();
filteredGames.forEach(game => {
  if (!uniqueGamesMap.has(game.id)) {
    uniqueGamesMap.set(game.id, game);
  }
});
const uniqueGames = Array.from(uniqueGamesMap.values());

  //uniqueGames.sort((a, b) => (b["3bv"] / b.clicks) - (a["3bv"] / a.clicks));
  uniqueGames.sort((a, b) => {
  const effA = a["3bv"] / a.clicks;
  const effB = b["3bv"] / b.clicks;

  if (effB !== effA) {
    return effB - effA;
  } else {
    return b["3bv"] - a["3bv"];
  }
});

  let infoText = '';
  if (playerid && playerid !== 0) {
    infoText += `Player: ${playerMap[playerid] || playerid} `;
  }
  if (mode && mode !== 0) {
    infoText += `Mode: ${modes[mode] || mode} `;
  }
  filterInfo.textContent = infoText || 'All games';

  let i = 0

  uniqueGames.forEach(game => {
    const playerName = playerMap[game.playerid] || 'Unknown';
    const modeName = modes[game.mode] || 'Unknown';
    const modeColor = modeColorMap[game.mode] || 'black';
    const efficiency = Math.round((game["3bv"] / game.clicks) * 100);
    const gameUrl = `https://minesweeper.online/game/${game.id}`;
    i++;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${i}</td>
      <td><a href="#" class="player-link" data-playerid="${game.playerid}">${playerName}</a></td>
      <td><a href="${gameUrl}" class="efficiency-text" target="_blank" rel="noopener noreferrer">${efficiency}%</a></td>
      <td>${game["3bv"]}</td>
      <td>${game.clicks}</td>
      <td><span style="color: var(--${modeColor});">${modeName}</span></td>
    `;
    tableBody.appendChild(row);
  });

  if (filteredGames.length === 0) {
    const row = document.createElement('tr');
    row.innerHTML = `<td colspan="6" style="text-align:center;">No games found</td>`;
    tableBody.appendChild(row);
  }

document.querySelectorAll('.player-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const pid = Number(e.target.dataset.playerid);
      updateURLWithPlayerId(pid);
    });
  });

  document.querySelectorAll('.mode-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const selectedMode = Number(e.target.dataset.mode);
      updateURLWithMode(selectedMode);
    });
  });
}


document.getElementById('remove-filters').addEventListener('click', () => {
  history.pushState(null, '', window.location.pathname);
  renderTable();
});

document.getElementById('next-mode').addEventListener('click', () => {
  const params = new URLSearchParams(window.location.search);
  const currentMode = Number(params.get('mode')) || 0;
  const modeIds = Object.keys(modes).map(Number).sort();
  const currentIndex = modeIds.indexOf(currentMode);
  const nextIndex = (currentIndex + 1) % (modeIds.length + 1);
  const nextMode = nextIndex === modeIds.length ? 0 : modeIds[nextIndex];

  if (nextMode === 0) {
    params.delete('mode');
  } else {
    params.set('mode', nextMode);
  }

  const newUrl = `${window.location.pathname}?${params.toString()}`;
  history.pushState(null, '', newUrl);
  renderTable();
});

renderTable();

window.addEventListener('popstate', renderTable);
